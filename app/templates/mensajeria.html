<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mensajería</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/nav.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/nav_roles.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/mensajeria.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/modal_reportar.css') }}">


  <!-- Google Fonts y Bootstrap Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>
</head>
<body>

   {% include 'nav.html' %}
  
  {# 🔹 Definimos la variable necesaria para el modal de reportar #}
  {% set id_usuario_logueado = reportador_id if reportador_id is defined else (id_usuario_logueado if id_usuario_logueado is defined else current_user.usuario_id) %}
  
  {% include "modal_reportar.html"%}
  {% include 'errors.html' %}


  <section class="chat-section">
    <div class="chat-app">
      <!-- Panel izquierdo -->
      <aside class="chat-sidebar">
        <div id="conversationsPanel">
          <div class="conversation">
            <div class="left">
              <img src="/static/uploads/default.jpg" alt="Perfil" />
              <div>
                <h2>Angie Salgado</h2>
                <small>Último mensaje...</small>
              </div>
            </div>
            <div class="right">
              <!-- Arriba -->
              <button class="menu-btn"><i class="bi bi-three-dots"></i></button>
              <!-- Centro -->
              <span class="time">21:23</span>
              <!-- Abajo -->
              <div class="badge" style="display:none;">1</div>
              <!-- Menú contextual -->
              <div class="contact-menu oculto">
              <span class="menu-close-btn">x</span>
              <a href="javascript:void(0);" class="btn-link abrir-modal-calificacion">
                <i class="bi bi-star"></i><span>Calificar</span>
              </a>
               <a href="javascript:void(0);" 
                   class="btn-link abrir-modal-reporte"
                   data-usuario-reportado="{{ reportado_id or '' }}"
                   data-usuario-reportador="{{ id_usuario_logueado }}">
                  <i class="bi bi-exclamation-circle"></i><span>Reportar</span>
                </a>
              <a href="#"><i class="bi bi-trash"></i><span>Eliminar</span></a>
            </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Panel derecho -->
      <section class="chat-panel" id="chatPanel">
        

          <div id="chatPlaceholder" class="chat-placeholder">
            <i class="bi bi-chat-dots"></i>
            <p>Selecciona un contacto para comenzar a chatear</p>
          </div>

        <div class="chat-content oculto" id="chatContent">
          <div class="top">
            <div class="profile">
              <!-- Imagen real del usuario -->
                 <span id="backIcon">&lt;</span>
              <img id="chatProfilePhoto" src="/static/uploads/default.jpg" alt="Avatar" class="perfil-img oculto">

              <!-- Ícono por defecto -->
              <i class="bi bi-person-circle perfil-img placeholder-icon"></i>

              <span id="chatUserName"></span>
            </div>

            <button id="viewProfileBtn">Ver perfil</button>
          </div>

          <div id="chatContainer"></div>

          <div id="messageBar">
            <div class="input-container">
              <input type="hidden" id="currentUserId" value="{{ current_user.usuario_id }}" />
              {% if session.get('abrir_chat_con') %}
                <input type="hidden" id="abrirChatCon" value="{{ session.pop('abrir_chat_con') }}">
              {% endif %}
              <textarea id="messageInput" placeholder="Escribe un mensaje…" autocomplete="off" rows="1"></textarea>
              <button id="sendBtn"><i class="bi bi-send-fill"></i></button>
            </div>
          </div>
        </div>

      </section>

  
  <input type="hidden" id="chatPartnerInicial" value="{{ session.pop('abrir_chat_con', '') }}">

  <!-- Modal Calificación -->
<div id="modalCalificacion" class="overlay-calificacion" style="display: none;">
  <div class="contenido-calificacion">
    <h2>Calificar usuario</h2>

    <!-- ✅ FORM agregado -->
    <form id="formCalificacion" action="{{  url_for('mensajeria.guardar_calificacion') }}"  method="POST">
      
      <!-- Estrellas -->
      <div class="estrellas-calificacion" id="estrellasCalificacion">
        <i class="bi bi-star" data-valor="1"></i>
        <i class="bi bi-star" data-valor="2"></i>
        <i class="bi bi-star" data-valor="3"></i>
        <i class="bi bi-star" data-valor="4"></i>
        <i class="bi bi-star" data-valor="5"></i>
      </div>

      <!-- Campo oculto para valor de estrellas -->
      <input type="hidden" id="valorCalificacion" name="valor_calificacion" value="0">
      <input type="hidden" name="calificador_id" value="{{ calificador_id }}">  
      <input type="hidden" name="calificado_id" id="calificadoId" value="{{ calificado_id }}">

      <!-- Reseña -->
      <div class="campo-calificacion">
        <textarea id="reseñaCalificacion" name="reseña" placeholder="Escribe una reseña" required></textarea>
      </div>

      <!-- Botones -->
      <div class="botones-calificacion">
        <button type="submit" class="btn-calificacion-guardar">Guardar</button>
        <button type="button" class="btn-calificacion-cancelar" id="cancelarModalCalificacion">Cancelar</button>
      </div>

    </form>
    <!-- ✅ Fin del FORM -->
  </div>
</div>

  <!-- Modal de Confirmación para eliminar -->
<div id="confirmModal" class="modal-overlay" style="display: none;">
  <div class="modal-content-delete">
    <p>¿Deseas eliminar esta conversación?</p>
    <div class="modal-buttons">
      <button id="confirmDelete" class="btn-aceptar">Aceptar</button>
      <button id="cancelDelete" class="btn-cancelar">Cancelar</button>
    </div>
  </div>
</div>


  
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <!-- JS personalizado -->
  <script src="{{ url_for('static', filename='js/mensajeria.js') }}"></script>
  <script src="{{ url_for('static', filename='js/modal_reportar.js') }}"></script>

 


</body>
</html>
